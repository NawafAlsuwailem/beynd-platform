#!/usr/bin/env node

/**
 * Automatic Commitizen + Husky setup (v9+ compatible)
 * ---------------------------------------------------
 * - Runs automatically after `npm install` in consuming services.
 * - Ensures Husky is installed and properly configured.
 * - Always (re)creates the commit-msg hook with the latest template.
 * - Fully automated ‚Äî no manual developer steps required.
 */

const { execSync } = require('child_process');
const path = require('path');
const fs = require('fs');

const projectRoot = process.env.INIT_CWD || path.resolve(__dirname, '../../');
const huskyDir = path.join(projectRoot, '.husky');
const hookPath = path.join(huskyDir, 'commit-msg'); // üëà use commit-msg, not prepare-commit-msg

console.log('üß† Initializing Commitizen + Husky setup...');

try {
    process.chdir(projectRoot);

    // Skip if not a Git repo
    if (!fs.existsSync(path.join(projectRoot, '.git'))) {
        console.log('‚ö†Ô∏è  Skipping Husky setup (no .git directory found).');
        process.exit(0);
    }

    // 1Ô∏è‚É£ Ensure Husky is installed
    if (!fs.existsSync(huskyDir)) {
        console.log('‚öôÔ∏è  Installing Husky...');
        execSync('npx husky install', { stdio: 'inherit' });
    }

    // 2Ô∏è‚É£ Ensure Git hook path is set
    execSync('git config core.hooksPath .husky', { stdio: 'inherit' });

    // 3Ô∏è‚É£ Always (re)create commit-msg hook
    console.log('ü™ù Updating commit-msg hook...');
    const hookContent = `#!/bin/sh

# Interactive Commitizen prompt (Husky v9+ safe)
if [ -t 0 ]; then
  exec < /dev/tty && npx cz --hook || true
fi
`;
    fs.writeFileSync(hookPath, hookContent);
    fs.chmodSync(hookPath, 0o755);

    console.log('üéâ Commitizen + Husky are ready! Run \`git commit\` to open the interactive prompt.');
} catch (err) {
    console.error('‚ùå Commitizen setup failed:', err.message);
    process.exit(0); // don‚Äôt break npm install
}
