#!/usr/bin/env node

/**
 * Automatic Commitizen + Husky setup (v9+ compatible)
 * ---------------------------------------------------
 * - Runs automatically after `npm install` in consuming services.
 * - Ensures Husky is installed and properly configured.
 * - Always recreates the commit hook with the latest template.
 * - Injects "commit": "cz" script automatically into package.json.
 * - Prevents Git from reopening the editor after interactive commit.
 */

const { execSync } = require("child_process");
const path = require("path");
const fs = require("fs");

const projectRoot = process.env.INIT_CWD || path.resolve(__dirname, "../../");
const huskyDir = path.join(projectRoot, ".husky");
const hookPath = path.join(huskyDir, "prepare-commit-msg");
const packageJsonPath = path.join(projectRoot, "package.json");

console.log("üß† Initializing Commitizen + Husky setup...");

try {
    process.chdir(projectRoot);

    // üß© Skip if not a Git repo (e.g. in CI)
    if (!fs.existsSync(path.join(projectRoot, ".git"))) {
        console.log("‚ö†Ô∏è  Skipping Husky setup (no .git directory found).");
        process.exit(0);
    }

    // 1Ô∏è‚É£ Ensure Husky is installed
    if (!fs.existsSync(huskyDir)) {
        console.log("‚öôÔ∏è  Installing Husky...");
        execSync("npx husky install", { stdio: "inherit" });
    }

    // 2Ô∏è‚É£ Ensure Git hook path is set
    execSync("git config core.hooksPath .husky", { stdio: "inherit" });

    // 3Ô∏è‚É£ Create/Update prepare-commit-msg hook
    console.log("ü™ù Creating prepare-commit-msg hook...");
    const hookContent = `#!/bin/sh
# Run Commitizen interactively before Git opens the editor
if [ -t 0 ]; then
  exec < /dev/tty && npx cz --hook || true
  # Stop Git from reopening the commit editor
  exit 0
fi
`;
    fs.writeFileSync(hookPath, hookContent);
    fs.chmodSync(hookPath, 0o755);

    // 4Ô∏è‚É£ Inject "commit": "cz" script into consuming project's package.json
    if (fs.existsSync(packageJsonPath)) {
        const pkg = JSON.parse(fs.readFileSync(packageJsonPath, "utf8"));
        pkg.scripts = pkg.scripts || {};
        if (!pkg.scripts.commit) {
            pkg.scripts.commit = "cz";
            fs.writeFileSync(packageJsonPath, JSON.stringify(pkg, null, 2));
            console.log("üß© Added `npm run commit` script to package.json");
        } else {
            console.log("‚úÖ `npm run commit` script already exists.");
        }
    }

    console.log("üéâ Commitizen + Husky setup complete!");
    console.log("üëâ Use `npm run commit` for interactive commits.");
} catch (err) {
    console.error("‚ùå Commitizen setup failed:", err.message);
    process.exit(0); // Don‚Äôt break npm install
}
